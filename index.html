<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Institut Laadjin Miloud</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;margin:0;background:#111;color:#fff}
nav{background:#000;padding:10px;display:flex;gap:15px}
nav a{color:#fff;cursor:pointer;text-decoration:none}
section{display:none;padding:20px}
.active{display:block}
button{padding:8px 12px;cursor:pointer}
input{padding:8px;margin:5px 0;width:100%}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center}
.modal-content{background:#222;padding:20px;width:300px}
</style>
</head>

<body>

<nav>
<a onclick="showSection('home')">Accueil</a>
<a onclick="openLogin('admin')">Admin</a>
<a onclick="openLogin('teachers')">Maîtres</a>
<a onclick="openLogin('group1')">Groupe 1</a>
<a onclick="logout()" id="logoutBtn" style="display:none">Déconnexion</a>
</nav>

<section id="home" class="active">
<h1>Bienvenue</h1>
</section>

<section id="resources">
<h2 id="resourcesTitle"></h2>
<div id="resourcesGrid"></div>
</section>

<section id="admin">
<h2>Admin</h2>
<button onclick="showManageGroups()">Gérer groupes</button>
<div id="groupsList"></div>
</section>

<div class="modal" id="loginModal">
<div class="modal-content">
<h3 id="loginTitle"></h3>
<input id="loginUser" placeholder="Utilisateur">
<input id="loginPass" type="password" placeholder="Mot de passe">
<button onclick="login()">Connexion</button>
<p id="loginError" style="color:red;display:none">Nom d'utilisateur ou mot de passe incorrect</p>
</div>
</div>

<script>
const SUPABASE_URL = "https://bsswnborkzyjqyvvxpci.supabase.co";
const SUPABASE_ANON_KEY = "TON_ANON_KEY_ICI";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentLoginType = null;

function showSection(id){
document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
document.getElementById(id).classList.add("active");
}

function openLogin(type){
currentLoginType = type;
document.getElementById("loginTitle").innerText = "Connexion " + type;
document.getElementById("loginError").style.display="none";
document.getElementById("loginModal").style.display="flex";
}

async function login(){
const u = loginUser.value;
const p = loginPass.value;
let table, field;

if(currentLoginType==="admin"){table="admins";field="username";}
else if(currentLoginType==="teachers"){table="apprentices";field="name";}
else{table="groups";field="id";}

let q = supabase.from(table).select("*");

if(field==="id"){q=q.eq("id",currentLoginType.replace("group",""))}
else{q=q.eq(field,u)}

const {data,error} = await q.single();
if(error||!data){fail();return}

const {data:ok} = await supabase.rpc("verify_password",{plain_password:p,hashed_password:data.password_hash});
if(!ok){fail();return}

document.getElementById("loginModal").style.display="none";
document.getElementById("logoutBtn").style.display="block";

if(currentLoginType==="admin"){showSection("admin");loadGroups();}
else{loadResources(currentLoginType);}
}

function fail(){
document.getElementById("loginError").style.display="block";
}

async function loadResources(type){
showSection("resources");
resourcesGrid.innerHTML="";
resourcesTitle.innerText="Ressources";

let q=supabase.from("links").select("*");
if(type.startsWith("group")){
q=q.eq("group_id",type.replace("group",""));
}

const {data}=await q;
data?.forEach(l=>{
resourcesGrid.innerHTML+=`<p><a href="${l.url}" target="_blank">${l.title}</a></p>`;
});
}

async function loadGroups(){
const {data}=await supabase.from("groups").select("*").order("id");
groupsList.innerHTML="";
data?.forEach(g=>{
groupsList.innerHTML+=`<p>Groupe ${g.id} : ${g.name}</p>`;
});
}

function showManageGroups(){
showSection("admin");
loadGroups();
}

function logout(){
location.reload();
}
</script>

</body>
</html>
